
services:
  # ==========================
  #  Microservices - Multi-AZ Setup
  # ==========================

  auth-service:
    image: mainguyenuit/auth-service:latest
    container_name: auth-service
    restart: always
    ports:
      - "3030:3030"
    depends_on:
      - postgres
      - redis
    logging:
      driver: awslogs
      options:
        awslogs-region: ap-southeast-1
        awslogs-group: /microservices/auth-service
        awslogs-stream: auth-service-${EC2_INSTANCE_ID:-default}
        awslogs-create-group: "true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3030/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    environment:
      # Multi-AZ database endpoints (use load balancer or cluster endpoint)
      - SPRING_DATASOURCE_URL=${POSTGRES_CLUSTER_URL:-jdbc:postgresql://postgres:5432/auth_service_db}
      - SPRING_DATASOURCE_USERNAME=admin
      - SPRING_DATASOURCE_PASSWORD=password
      # Multi-AZ Redis endpoints
      - SPRING_DATA_REDIS_HOST=${REDIS_CLUSTER_HOST:-redis}
      - SPRING_DATA_REDIS_PORT=6379
    networks:
      - app-network

  driver-service:
    image: mainguyenuit/driver-service:latest
    container_name: driver-service
    restart: always
    ports:
      - "3031:3031"
    depends_on:
      - mongodb
      - kafka
      - redis
    logging:
      driver: awslogs
      options:
        awslogs-region: ap-southeast-1
        awslogs-group: /microservices/driver-service
        awslogs-stream: driver-service-${EC2_INSTANCE_ID:-default}
        awslogs-create-group: "true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3031/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    environment:
      # Multi-AZ MongoDB cluster URI
      - SPRING_DATA_MONGODB_URI=${MONGODB_CLUSTER_URI:-mongodb://mongodb:27017/driver-db}
      # Multi-AZ Kafka cluster bootstrap servers
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      - SPRING_DATA_REDIS_HOST=${REDIS_CLUSTER_HOST:-redis}
      - SPRING_DATA_REDIS_PORT=6379
    networks:
      - app-network

  trip-service:
    image: mainguyenuit/trip-service:latest
    container_name: trip-service
    restart: always
    ports:
      - "3032:3032"
    depends_on:
      - mongodb
      - kafka
    logging:
      driver: awslogs
      options:
        awslogs-region: ap-southeast-1
        awslogs-group: /microservices/trip-service
        awslogs-stream: trip-service-${EC2_INSTANCE_ID:-default}
        awslogs-create-group: "true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3032/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    environment:
      # Multi-AZ MongoDB cluster URI
      - SPRING_DATA_MONGODB_URI=${MONGODB_CLUSTER_URI:-mongodb://mongodb:27017/trip-db}
      # Multi-AZ Kafka cluster bootstrap servers
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
            # Multi-AZ Redis endpoints
      - SPRING_DATA_REDIS_HOST=${REDIS_CLUSTER_HOST:-redis}
      - SPRING_DATA_REDIS_PORT=6379
    networks:
      - app-network

# ==========================
#  Networks
# ==========================
networks:
  app-network:
    driver: bridge
    name: microservices-network